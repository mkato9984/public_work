#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
RAGã‚·ã‚¹ãƒ†ãƒ ã®Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
"""
import os
import json
import traceback
from datetime import datetime
from dotenv import load_dotenv
from flask import Flask, request, jsonify, render_template

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
load_dotenv()

app = Flask(__name__, static_folder="static", template_folder="templates")

# ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
rag = None
rag_initialized = False
initialization_error = None

def safe_initialize_rag():
    """å®‰å…¨ãªRAGã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–"""
    global rag, rag_initialized, initialization_error
    
    if rag_initialized:
        return rag is not None
    
    try:
        print("ğŸ”§ RAGã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...")
        
        # æ®µéšçš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        print("  ğŸ“¦ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...")
        from rag_system import RAGSystem
        from config import Config
        print("  âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†")
        
        # APIã‚­ãƒ¼ç¢ºèª
        print("  ğŸ”‘ APIã‚­ãƒ¼ç¢ºèªä¸­...")
        api_key = Config.GOOGLE_API_KEY
        if not api_key:
            initialization_error = "APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            print(f"  âŒ {initialization_error}")
            rag_initialized = True
            return False
        print(f"  âœ… APIã‚­ãƒ¼ç¢ºèªå®Œäº†: {api_key[:10]}...")
        
        # RAGã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        print("  ğŸ—ï¸  RAGã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆä¸­...")
        rag = RAGSystem()
        print("  âœ… RAGã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå®Œäº†")
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
        print("  ğŸ—„ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ä¸­...")
        db_success = rag.initialize_database()
        if db_success:
            print("  âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†")
            rag_initialized = True
            return True
        else:
            initialization_error = "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å¤±æ•—"
            print(f"  âŒ {initialization_error}")
            rag_initialized = True
            return False
            
    except Exception as e:
        initialization_error = f"åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {str(e)}"
        print(f"  âŒ {initialization_error}")
        print(f"  ğŸ“‹ è©³ç´°: {traceback.format_exc()}")
        rag_initialized = True
        return False

@app.route('/')
def index():
    """ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸"""
    try:
        return render_template('index.html')
    except Exception as e:
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return f"""
        <!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <title>RAG System</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; }}
                .container {{ max-width: 800px; margin: 0 auto; }}
                .error {{ background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 5px; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>RAG System</h1>
                <div class="error">
                    <h2>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼</h2>
                    <p>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {str(e)}</p>
                    <p>åŸºæœ¬çš„ãªæ©Ÿèƒ½ã¯ä»¥ä¸‹ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§åˆ©ç”¨ã§ãã¾ã™ï¼š</p>
                    <ul>
                        <li><code>/api/status</code> - ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª</li>
                        <li><code>/api/add_document</code> - æ–‡æ›¸è¿½åŠ </li>
                        <li><code>/api/ask</code> - è³ªå•å¿œç­”</li>
                    </ul>
                </div>
            </div>
        </body>
        </html>
        """

@app.route('/api/status')
def api_status():
    """ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª"""
    try:
        print("ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªãƒªã‚¯ã‚¨ã‚¹ãƒˆ")
        
        # åˆæœŸåŒ–çŠ¶æ…‹ã‚’ç¢ºèª
        is_ready = safe_initialize_rag()
        
        status = {
            "status": "ready" if is_ready else "error",
            "rag_initialized": rag_initialized,
            "error": initialization_error,
            "timestamp": datetime.now().isoformat(),
            "api_key_set": bool(os.getenv('GOOGLE_API_KEY'))
        }
        
        if is_ready and rag:
            try:
                status["document_count"] = rag.get_document_count()
            except Exception as e:
                status["document_count_error"] = str(e)
        
        print(f"ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: {status['status']}")
        return jsonify(status)
        
    except Exception as e:
        error_status = {
            "status": "error",
            "error": str(e),
            "timestamp": datetime.now().isoformat()
        }
        print(f"âŒ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}")
        return jsonify(error_status), 500

@app.route('/api/add_document', methods=['POST'])
def add_document():
    """æ–‡æ›¸è¿½åŠ """
    try:
        print("ğŸ“„ æ–‡æ›¸è¿½åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ")
        
        if not safe_initialize_rag():
            return jsonify({
                "success": False,
                "error": initialization_error or "RAGã‚·ã‚¹ãƒ†ãƒ æœªåˆæœŸåŒ–"
            }), 500
        
        data = request.get_json()
        if not data:
            return jsonify({"success": False, "error": "JSONãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™"}), 400
        
        title = data.get('title', '').strip()
        content = data.get('content', '').strip()
        metadata = data.get('metadata', {})
        
        if not title or not content:
            return jsonify({"success": False, "error": "ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã¯å¿…é ˆã§ã™"}), 400
        
        print(f"ğŸ“„ æ–‡æ›¸è¿½åŠ : {title}")
        success = rag.add_document(title, content, metadata)
        
        if success:
            print(f"âœ… æ–‡æ›¸è¿½åŠ æˆåŠŸ: {title}")
            return jsonify({"success": True, "message": "æ–‡æ›¸ãŒæ­£å¸¸ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ"})
        else:
            print(f"âŒ æ–‡æ›¸è¿½åŠ å¤±æ•—: {title}")
            return jsonify({"success": False, "error": "æ–‡æ›¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ"}), 500
    
    except Exception as e:
        print(f"âŒ æ–‡æ›¸è¿½åŠ ã‚¨ãƒ©ãƒ¼: {e}")
        return jsonify({"success": False, "error": str(e)}), 500

@app.route('/api/ask', methods=['POST'])
def ask_question():
    """è³ªå•å¿œç­”"""
    try:
        print("â“ è³ªå•å¿œç­”ãƒªã‚¯ã‚¨ã‚¹ãƒˆ")
        
        if not safe_initialize_rag():
            return jsonify({
                "success": False,
                "error": initialization_error or "RAGã‚·ã‚¹ãƒ†ãƒ æœªåˆæœŸåŒ–"
            }), 500
        
        data = request.get_json()
        if not data:
            return jsonify({"success": False, "error": "JSONãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™"}), 400
        
        question = data.get('question', '').strip()
        if not question:
            return jsonify({"success": False, "error": "è³ªå•ã¯å¿…é ˆã§ã™"}), 400
        
        print(f"â“ è³ªå•: {question}")
        
        # é–¢é€£æ–‡æ›¸æ¤œç´¢
        similar_docs = rag.search_similar_documents(question, top_k=3)
        print(f"ğŸ” é–¢é€£æ–‡æ›¸æ•°: {len(similar_docs)}")
        
        # å›ç­”ç”Ÿæˆ
        answer = rag.answer_question(question)
        print(f"âœ… å›ç­”ç”Ÿæˆå®Œäº†")
        
        return jsonify({
            "success": True,
            "answer": answer,
            "related_documents": similar_docs
        })
    
    except Exception as e:
        print(f"âŒ è³ªå•å¿œç­”ã‚¨ãƒ©ãƒ¼: {e}")
        return jsonify({"success": False, "error": str(e)}), 500

@app.route('/test')
def test_page():
    """ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸"""
    return """
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>RAG System Test</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .container { max-width: 800px; margin: 0 auto; }
            .success { background: #d4edda; padding: 20px; border-radius: 5px; margin: 20px 0; }
            button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
            #result { background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; white-space: pre-wrap; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="success">
                <h1>ğŸ‰ RAG System ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
                <p>Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼</p>
            </div>
            
            <h2>ğŸ§ª API ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testStatus()">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª</button>
            <button onclick="testAddDocument()">æ–‡æ›¸è¿½åŠ ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testQuestion()">è³ªå•å¿œç­”ãƒ†ã‚¹ãƒˆ</button>
            
            <div id="result">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
        
        <script>
        async function testStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                document.getElementById('result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('result').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }
        
        async function testAddDocument() {
            try {
                const response = await fetch('/api/add_document', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: 'ãƒ†ã‚¹ãƒˆæ–‡æ›¸',
                        content: 'ã“ã‚Œã¯Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆæ–‡æ›¸ã§ã™ã€‚',
                        metadata: {source: 'web_test'}
                    })
                });
                const data = await response.json();
                document.getElementById('result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('result').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }
        
        async function testQuestion() {
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question: 'ãƒ†ã‚¹ãƒˆæ–‡æ›¸ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„'
                    })
                });
                const data = await response.json();
                document.getElementById('result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('result').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }
        </script>
    </body>
    </html>
    """

if __name__ == '__main__':
    print("=" * 60)
    print("ğŸš€ RAG System Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (ãƒ‡ãƒãƒƒã‚°ç‰ˆ)")
    print("=" * 60)
    
    # ç’°å¢ƒç¢ºèª
    print(f"ğŸ“ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {os.getcwd()}")
    print(f"ğŸ”‘ API Key: {'è¨­å®šæ¸ˆã¿' if os.getenv('GOOGLE_API_KEY') else 'æœªè¨­å®š'}")
    print(f"ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€: {os.path.exists('templates')}")
    print(f"ğŸ“„ index.htmlãƒ•ã‚¡ã‚¤ãƒ«: {os.path.exists('templates/index.html')}")
    
    port = 5000
    print(f"ğŸŒ èµ·å‹•URL: http://localhost:{port}")
    print(f"ğŸ§ª ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸: http://localhost:{port}/test")
    print("=" * 60)
    
    # ãƒ•ãƒ©ã‚¹ã‚¯ã®èµ·å‹•
    app.run(host='127.0.0.1', port=port, debug=True, use_reloader=False)
